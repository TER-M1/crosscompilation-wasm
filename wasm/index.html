<!--
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Audio Worklet and WebAssembly | WebAudio Samples</title>
  </head>
  <body>
    <button id="btn-start">Start</button>

    <script type="module">
      // import WorkletDemoBuilder from '../../assets/WorkletDemoBuilder.js'
      // import PageData from './PageData.js';
      (async () => {

        function unlockAudioContext(audioCtx) {
          if (audioCtx.state !== 'suspended') return;
          const b = document.body;
          const events = ['touchstart','touchend', 'mousedown','keydown'];
          events.forEach(e => b.addEventListener(e, unlock, false));
          function unlock() { audioCtx.resume().then(clean); }
          function clean() { events.forEach(e => b.removeEventListener(e, unlock)); }
        }
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      await audioCtx.audioWorklet.addModule('wasm-worklet-processor.js');
      const oscillator = new OscillatorNode(audioCtx);
      const bypasser = new AudioWorkletNode(audioCtx, 'wasm-worklet-processor');
      oscillator.connect(bypasser).connect(audioCtx.destination);
      unlockAudioContext(audioCtx);

      bypasser.parameters.playing.value = 0;
      console.log(audioCtx)

      oscillator.start();
      var btnStart = document.getElementById("btn-start");
      btnStart.onclick = () => {
          if (audioCtx.state === "suspended") audioCtx.resume();
        const playing = bypasser.parameters.get("playing").value;
        if (playing === 1) {
          bypasser.parameters.get("playing").value = 0;
            btnStart.textContent = "Start";
        } else {
          bypasser.parameters.get("playing").value = 1;
            btnStart.textContent = "Stop";
        }
      };

    })();

      // WorkletDemoBuilder(PageData, demoCode);
    </script>
  </body>
</html>
